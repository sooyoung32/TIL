# 연관관계 매핑 기초

- 객체와 DB의 패러다임의 불일치가 있어 객체와 테이블 연관관계 차이를 이해
- 객체의 참조와 테이블의 외래키를 매핑

**용어**

- 방향  : 단방향, 양방향
- 다중성 : 다대일, 일대다, 일대일,다대다
- 연관관계의 주인(Owner)  : 객체양방향 연관관계는 관리가 필요.

### 연관관계가 필요한 이유

- 객체지향 설계는 자율적인 객체들의 협력 공동체를 만드는것
- 회원 팀 다 : 1
- 객체를 테이블에 맞추어 모델링 하는 경우 외래키 식별자를 직접 다뤄서 협력관계를 만들 수 없음

### 단반향 연관관계

- 객체는 회원 → 팀 단방향이 가능
- 테이블은 외래키로 조인하기 때문에 양방향 관계
- @ManyToOne
- @OneToMany
- @JoinColumn

### 양방향 연관관계

양방향 연관관계와 연관관계의 주인을 알아야 함

- 객체 참조 - 단뱡향 관계가 2개 있는 것
    - 회원 → 팀
    - 팀 → 회원
- 테이블 외래키 - 방향이 없고 외래키만 있으면됨@mappedBy

연관관계의 주인을 알아야함

- 객체
    - 회원 → 팀  (N: 1)
    - 팀  → 회원  (1 :N)
    - 객체의 양방향 관계는 사실 양방향 관계가 아니라 서로다른 단방향 관계 2개
- 테이블
    - 회원↔ 팀 연관관계 외래키 (방향이 존재하지 않음. 외래키하나면 다 가능)
    - 테이블의 양방향은 테이블은 외래키 하나로 두 테이블을 관리하기 때문에 외래키 하나로 양뱡향 연관관계를 가짐
- 객체와 테이블 둘 중 하나로 외래키를 관리해야 함! → 연관관계의 주인
    - 테이블에선 외래키만 업데이트 하면 되지만 객체에선 주인이 없으면 수정이 일어날때 , 멤버의 팀을 변경해야 하는지, 팀의 멤버를 변견해야하는지 혼란스러워짐

### 연관관계의 주인

- 양방향 매핑규칙
- 객체 두개중 하나를 주인으로 지정
- 연관관계 주인만이 외래키를 관리
- 주인이 아닌쪽은 읽기만 가능
- 주인은 mappedBy 속성을 사용하면 안됨
- 주인이 아니면 mappedBy속성으로 주인 지정!!!
- 누가 주인을 하는가?
    - 테이블 외래키가 있는 곳으로 주인으로 정해라
    - db 에서 보면 n쪽에 외래키를 가짐 그럼 즉 다  쪽이 주인이 됨
    - 주인이라고 하니까 비즈니스에서 중요할것 같은데 그건 아님

### 자주하는 실수

- 연관관계 주인에 값을 입력하지 않음
- 양방향 매핑시 연관관계의 주인에 값을 입력해야함
- 순수한 객체 관계를 고려하면 항상 양쪽에 값을 입력하는게 맞다
- 둘다 넣어주지 않으면 flush() clear() 를 하지않으면 캐시에 있는 값이 조회됨.
- 항상 양쪽에 값을 설정하자
- 연관관계 편의 메소드를  생성하자 → changeTeam 이런걸로 이름 변경
- 양방향 매핑시 무한루프를 조심하자

## 결론

- 단방향 매핑만으로 연관관계 매핑은 완료하자 → 웬만하면 양방향 매핑은 하지말자
- 양방향으로 할때는 연관관계의 주인은 외래키가 있는 곳으로 정하자.
- 양방향 매핑은 반대 방향으로 조회(그래프탐색)기능이 추가된 것 뿐
- 단방향매핑을 잘하고 양방향은 필요할때 추가해도됨.